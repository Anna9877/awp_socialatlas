---
title: "Athens Social Atlas"
resource_files:
- ElementarySchoolDistricts_data.cpg
- ElementarySchoolDistricts_data.dbf
- ElementarySchoolDistricts_data.prj
- ElementarySchoolDistricts_data.qpj
- ElementarySchoolDistricts_data.shp
- ElementarySchoolDistricts_data.shx
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    theme: cerulean
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(leaflet)
#library(rgdal)
library(RColorBrewer)
library(classInt)
library(highcharter)
library(plotly)
library(ggplot2)
#library(reshape2)
#library(readxl)
library(sf)
library(tidyverse)
#library(googlesheets)
options(shiny.error = browser)

#atlasgoogle<-gs_url("https://docs.google.com/spreadsheets/d/1ACdNruOZAI7jlzJ3RR49S788jtK1_1qSGWBXSumuLLg/edit?usp=sharing")
#atlasdata_wide<-gs_read(sheet,ws="Data")
#metadata<-gs_read(sheet,ws="Metadata")
#atlasdata<-melt(atlasdata_wide,id.vars=c("School","SchoolID"))


# atlasdata_wide<-atlasdata %>% 
#   select(-moe) %>%
#   spread(var,est) 
districts<-st_read("app_old/ElementarySchoolDistricts_data.shp") %>%
  select(SchoolID, ES_short) 
atlasdata<-read_csv("data/AthensSocialAtlasData_2018_04_23.csv")
metadata<-read_csv("data/AthensSocialAtlasData_metadata_2018_02_05.csv")

#Adding variable description to old data. Will delete eventually.
# metadatashort<-metadata %>%
#   select(variable,description) %>%
 #  rename("var"= "variable")
 #atlasdata<-atlasdata %>%
#   left_join(metadatashort)
# write_csv(atlasdata,"data/AthensSocialAtlasData_2018_04_23.csv")

#middle school data
middleschool <- st_read("data/MiddleSchoolDistrictsWGS84.geojson")

#First I subsetted the data based on category.
#After that, I make sure to sorts all the variables  int that categroy in ascending order and remove duplicate fields.
#safety variables
safetyvariables <-subset(metadata, Community_safety == 1)
select_safety <- sort(unique(safetyvariables$description))
#demographic variables
demovariables <-subset(metadata, Demographics == 1)
select_demo <- sort(unique(demovariables$description))
#health variables
healthvariables <-subset(metadata, Health == 1)
select_health <- sort(unique(healthvariables$description))
#housing variables
housingvariables <-subset(metadata, Housing == 1)
select_housing <- sort(unique(housingvariables$description))
#income and employment variables
incemployvariables <-subset(metadata, Income_employment == 1)
select_incemploy <- sort(unique(incemployvariables$description))
#education variables
eduvariables <- subset(metadata, Education == 1)
select_edu <- sort(unique(eduvariables$description))
#transportation variables
transvariables <- subset(metadata, Transportation == 1)
select_trans <- sort(unique(transvariables$description))


#For the two issue page, I am doing the same as above for the second variable.
#safety variables
select2_safety <- sort(unique(safetyvariables$description))
#demographic variables
select2_demo <- sort(unique(demovariables$description))
#health variables
select2_health <- sort(unique(healthvariables$description))
#housing variables
select2_housing <- sort(unique(housingvariables$description))
#income and employment variables
select2_incemploy <- sort(unique(incemployvariables$description))
#education variables
select2_edu <- sort(unique(eduvariables$description))
#transportation variables
select2_trans <- sort(unique(transvariables$description))







```
Single issue
===================================== 

Column {.sidebar}
-----------------------------------------------------------------------

####Variable selection

```{r}
radioButtons("ngroups","Classify school zones into how many equally sized groups?",c(3, 4,5,6),selected=4)

 radioButtons("group","Choose your variable domain:",
              c("Community Safety"="Safety",
                "Demographics"="Demog",
                "Healthy People & Environments"="Health",
                "Housing"="Housing",
                "Income & Employment" = "Income",
                "Lifelong Learning" = "Learning",
                "Transportation" = "Transport"),
              selected="Safety")
 



 conditionalPanel(
  condition="input.group =='Safety'",
   selectInput("variable1","Select your variable:",
               choices = select_safety)
 )
 
 conditionalPanel(
  condition="input.group =='Demog'",
   selectInput("variable2","Select your variable:",
                choices = select_demo)
 )
 
 conditionalPanel(
  condition="input.group =='Health'",
   selectInput("variable3","Select your variable:",
               choices = select_health)
 )
 
 
 conditionalPanel(
  condition="input.group=='Housing'",
   selectInput("variable4","Select your variable:",
               choices = select_housing)
 )
 
 
 conditionalPanel(
  condition="input.group =='Income'",
   selectInput("variable5","Select your variable:",
               choices = select_incemploy)
 
 ) 
 
 conditionalPanel(
  condition="input.group=='Learning'",
   selectInput("variable6","Select your variable:",
              choices = select_edu)
 )
 
 conditionalPanel(
  condition="input.group=='Transport'",
   selectInput("variable7","Select your variable:",
               choices = select_trans)
 )
 

#Use the variable object to select the variable people choose
 variable<-reactive({
     if(input$group=="Safety"){
     input$variable1
   } else if (input$group=="Demog") {
     input$variable2
   } else if (input$group=="Health") {
     input$variable3
   } else if (input$group=="Housing") {
     input$variable4
   } else if (input$group=="Income") {
     input$variable5
   } else if (input$group=="Learning") {
     input$variable6
   } else if (input$group=="Transport") {
     input$variable7 }
   })

```

Column {data-width=450}
-----------------------------------------------------------------------
```{r fig.height=10}
#Text box from the metadata file that shows what variable has been selected


 filter_metadata<-reactive({
     var_code<-metadata %>%
          filter(metadata$description==variable())
   })

 output$text<-renderUI(
   HTML(paste("<b>Variable name: </b>",filter_metadata()$description,
              "<br><b>Source: </b>",filter_metadata()$source,"<br><br>",sep=""))
 )

 htmlOutput("text")
```

###Click on a school zone for more information.

```{r}
 
filteredData_variable <- reactive({
  
  
  
  #filter the dataset based on input variables. The comma is used to specify rows.
  adataset <- atlasdata[atlasdata$description == variable(),]
  
  #copy the data
  dist <- districts
  
  #subset the data
  dist <- suppressWarnings(left_join(dist, adataset, by = "SchoolID"))
  
  #dist
 })

##test
#filter1 <- atlasdata[atlasdata$description == "Has health insurance foreign born and naturalized",]

output$map <- renderLeaflet({
   
    
  mapdata <- filteredData_variable()
  
  nclassint= as.numeric(input$ngroups)
  
  pal <- colorQuantile("Reds", mapdata$est, n = nclassint)
  
  #did this in order to make the values not show up as percentages
 
  
    popup<-paste("<b>School zone: </b>", mapdata$School,"<br>",
                    "<b>Variable value:</b> ", mapdata$est,
                    sep="")
  
   leaflet(mapdata) %>%
  setView(lng = -83.3776, lat = 33.94, zoom = 11) %>%
   addProviderTiles("CartoDB.Positron",
                   options = providerTileOptions(noWrap = TRUE)) %>%
   addPolygons(
                data = mapdata,
                fillColor = ~pal(est),
                fillOpacity = .5,
                color = "#222222",
                weight = 1,
                popup = popup
               ) %>%
    addLegend(position="bottomright",
              pal = pal, 
              title="Legend",
              values = mapdata$est,
              labFormat = function(type, cuts, p){
                n = length(cuts)
                paste0(cuts[-n], " &dash; ", cuts[-1])
              })
})



leafletOutput("map", height="3000px")
                  

```

Column {.tabset data-width=300}
-----------------------------------------------------------------------
### Chart

```{r}


#This reactive variable is used to filter out the selected variable and chart it on a data chart. 
#variable_h1 sorts the variables high to low.
#variable_lh sorts the variables low to high.

#for 5/8/18 try deleting the variable names and create two reactive variables. See what happens.

 

 datachart<-reactive({
    
    #filtering the variable's data based on the selected category and assigning it to a new variable
  if (input$chart_sort1 == "School"){
     filteredvar <- atlasdata[atlasdata$description == variable(),]
   
  } else if (input$chart_sort1 == "Variable_hl"){
    filteredvar <- atlasdata[atlasdata$description == variable(),]
    filteredvar <- filteredvar[order(-filteredvar$est),]
  } else if (input$chart_sort1 == "Variable_lh"){
    filteredvar <- atlasdata[atlasdata$description == variable(),]
    filteredvar <- filteredvar[order(filteredvar$est),]
  }
   
   
  filteredvar   
    

 })
 

###testing highchart###
#filter1 <- atlasdata[atlasdata$description == "Mean Home Value",]

#filter1 <- atlasdata[order(-atlasdata$est)]

#hchart(filter1, "bar", hcaes(x = filter1$School, y = filter1$est))
#######
 output$highchart<-renderHighchart({
   
   #chartvar = datachart()

   hchart(datachart(), "bar", hcaes(x=School, y=est)) %>% 
     hc_add_theme(hc_theme_gridlight()) %>%
     hc_colors("#bd0026") %>%
     hc_yAxis(title = list(text = "Variable value"))
 })
 
 fillCol(height="80%",flex=c(.08,1),
       radioButtons("chart_sort1","Sort the chart by what criteria?",
             c("School name"="School",
               "Variable (high->low)"="Variable_hl",
               "Variable (low->high)"="Variable_lh"),inline=TRUE),
      # br(), br(),
 highchartOutput('highchart')
 )


```

### Table

Values for this variable by school zone. Click on "Value" to sort.

```{r}
# output$table<-renderDataTable(
#     atlasdata[atlasdata$variable==variable(),c(1,4)],
#   options=list(paging=FALSE,searching=FALSE)
# )
# 
# dataTableOutput('table')
```





Middle School Data
===================================== 

Column {.sidebar}
-----------------------------------------------------------------------

####Variable selection
```{r}
radioButtons("ngroups2","Classify school zones into how many equally sized groups?",c(3, 4,5,6),selected=4)

radioButtons("group2","Choose your variable domain:",
              c("Community Safety"="Safety",
                "Demographics"="Demog",
                "Healthy People & Environments"="Health",
                "Housing"="Housing",
                "Income & Employment" = "Income",
                "Lifelong Learning" = "Learning",
                "Transportation" = "Transport"),
              selected="Safety")


```
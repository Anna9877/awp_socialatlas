---
title: "Athens Social Atlas"
resource_files:
- ElementarySchoolDistricts_data.cpg
- ElementarySchoolDistricts_data.dbf
- ElementarySchoolDistricts_data.prj
- ElementarySchoolDistricts_data.qpj
- ElementarySchoolDistricts_data.shp
- ElementarySchoolDistricts_data.shx
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    theme: cerulean
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(leaflet)
library(RColorBrewer)
library(classInt)
library(highcharter)
library(plotly)
library(ggplot2)
library(sf)
library(tidyverse)

#library(googlesheets)
options(shiny.error = browser)

#this will load the helpers file. This helpers file contains the code which loads the shapefiles for the 
#elementary and middle school districts, formats the data, and joins the data. This file was made in order to reduce
#the amount of code in this file.

source("awp_shiny_helper.R")

```
Census Tracts with Elementary School Zones
===================================== 

Column {.sidebar}
-----------------------------------------------------------------------

#### Variable selection

```{r}
#This section creates the menu options for the app. In this section, you can classify the school zones in a 
#selected number of groups along with selecting variables within a particular domain. The selected variable will be 
#mapped on a leaflet map along with being displayed in a bar chart and a data table.
radioButtons("ngroups","Classify school zones into how many equally sized groups?",c(3, 4,5,6),selected=4)

 radioButtons("group","Choose your variable domain:",
              c("Demographics"="Demog",
                #"Community Safety"="Safety",
                "Healthy People & Environments"="Health",
                "Housing"="Housing",
                "Income & Employment" = "Income",
                "Lifelong Learning" = "Learning",
                "Transportation" = "Transport"),
              selected="Demog")
 



 conditionalPanel(
  condition="input.group =='Safety'",
   selectInput("variable1","Select your variable:",
               choices = select_safety)
 )
 
 conditionalPanel(
  condition="input.group =='Demog'",
   selectInput("variable2","Select your variable:",
                choices = select_demo)
 )
 
 conditionalPanel(
  condition="input.group =='Health'",
   selectInput("variable3","Select your variable:",
               choices = select_health)
 )
 
 
 conditionalPanel(
  condition="input.group=='Housing'",
   selectInput("variable4","Select your variable:",
               choices = select_housing)
 )
 
 
 conditionalPanel(
  condition="input.group =='Income'",
   selectInput("variable5","Select your variable:",
               choices = select_incemploy)
 
 ) 
 
 conditionalPanel(
  condition="input.group=='Learning'",
   selectInput("variable6","Select your variable:",
              choices = select_edu)
 )
 
 conditionalPanel(
  condition="input.group=='Transport'",
   selectInput("variable7","Select your variable:",
               choices = select_trans)
 )
 

#Use the variable object to select the variable people choose. When the domain is chosen, the appropriate variables will
#be loaded. 
 variable<-reactive({
     if(input$group=="Safety"){
     input$variable1
   } else if (input$group=="Demog") {
     input$variable2
   } else if (input$group=="Health") {
     input$variable3
   } else if (input$group=="Housing") {
     input$variable4
   } else if (input$group=="Income") {
     input$variable5
   } else if (input$group=="Learning") {
     input$variable6
   } else if (input$group=="Transport") {
     input$variable7 }
   })

```

Map by the [Community Mapping Lab](http://www.communitymappinglab.org) at the University of Georgia

```{r}
img(src='awp_logo.png', align = "left",width="100%")
```


Column {data-width=450}
-----------------------------------------------------------------------

```{r fig.height=40}
#Text box from the metadata file that shows what variable has been selected.
 filter_metadata<-reactive({
     var_code<-metadata %>%
          filter(metadata$description==variable())
   })

 text<-reactive({
   HTML(paste("<b>Variable shown: </b>",filter_metadata()$description,
              "<br><b>Source: </b>",filter_metadata()$source ))
 })

#This reactive variable will be used to filter the data.
filteredData_variable <- reactive({
  #Join metadata description
  metadata_popup<-metadata %>%
    select(variable,popup_lab,pct) %>%
    rename("var"=variable)
  
  #filter the dataset based on input variables. The comma is used to specify rows.
  adataset <- atlasdata %>%
    left_join(metadata_popup) %>%
    filter(description == variable()) 
    
  #subset the data
  suppressWarnings(left_join(districts, adataset, by = "GEOID") %>%
                     mutate(moe_disp=if_else(moe==-99,"NA",as.character(moe)),
           popup_text=paste("<b>Census Tract: </b>", substr(GEOID,6,11),"<br>",
                      "<b>School Zone(s): </b>", School,"<br>",  
                    "<b>",description,":</b> ", est,"<br>",
                 "<b>Estimate margin of error: </b>", moe,"<br>"))) 
  
 })

##Add the map
output$map<-renderLeaflet({
  nclassint<- as.numeric(input$ngroups)
  pal <- colorBin("Reds", filteredData_variable()$est, bins = nclassint, pretty = FALSE)
  
  leaflet() %>%
    clearShapes() %>%
    addProviderTiles(providers$CartoDB.Positron) %>%
    setView(-83.3754259340566, 33.948728234467396, zoom = 12) %>%
    addPolygons(data=filteredData_variable(),
                fillColor = ~pal(est),
                fillOpacity = 0.6,
                color = "#222222",
                weight = 1,
                stroke = FALSE,
                popup=filteredData_variable()$popup_text,
                highlightOptions = highlightOptions(color = "black",
                                                    weight = 5, 
                                                    fillColor = 'yellow',
                                                    fillOpacity = 0.2)) %>%
    addPolygons(data = es_zones,
                fill = FALSE,
                stroke = TRUE,
                color = "black",
                weight = 2.5,
                group = "Elementary School Zones") %>%
    addPolygons(data = acc_tracts,
                fill = FALSE,
                stroke = TRUE,
                color = "black",
                weight = 2,
                group = "ACC Tracts") %>%
    addControl(HTML("Click on highlighted census tract for more information."),position="bottomright") %>%
    addLayersControl(baseGroups = c("Elementary School Zones", "ACC Tracts"),
                     position = "bottomleft",
                     options = layersControlOptions(collapsed = FALSE)) %>%
    addLegend(position="bottomright",
              pal = pal,
              title="Legend",
              values = filteredData_variable()$est,
              labFormat = labelFormat(digits = 0)) %>% 
    addControl(text(),position="topright")
})


leafletOutput("map", height="3000px")

```
